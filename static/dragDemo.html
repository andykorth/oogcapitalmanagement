<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Inventory Drag + Quantity Drop Options POC</title>
<style>
  :root { --bg: #262626; --panel: #2b2b2b; --muted: #bdbdbd; }
  html,body { height:100%; margin:0; background:var(--bg); color:#eee; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }

  .wrap {
    display:flex;
    gap:20px;
    padding:20px;
    user-select:none;
    height:300px;
    box-sizing:border-box;
  }

  .inventory {
    width:320px;
    min-height:360px;
    border:2px solid #3b3b3b;
    border-radius:8px;
    padding:10px;
    padding-top: 40px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    position:relative;
    background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.01));
    align-content: flex-start;
  }

  .inventory.highlight {
    box-shadow: 0 0 0 4px rgba(242, 255, 120, 0.06);
    border-color: #6ea7ff;
  }

  .item {
    width:60px;
    height:60px;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:6px;
    cursor:grab;
    font-weight:700;
    position:relative;
    box-shadow: 0 1px 0 rgba(0,0,0,0.2) inset;
    
    background: linear-gradient(180deg, rgba(255,255,255,0.3), rgba(255,255,255,0.01));
  }

  .item .qty {
    position:absolute;
    right:4px;
    bottom:3px;
    font-size:11px;
    background:rgba(0,0,0,0.25);
    padding:2px 4px;
    border-radius:6px;
    color:var(--muted);
    font-weight:600;
  }

  .item.selected { outline:3px solid rgba(255,255,255,0.18); transform: scale(1.03); }

  #selectionRect {
    position:fixed;
    border:2px dashed rgba(0,200,120,0.35);
    background: rgba(0,200,120,0.06);
    pointer-events: none;
    z-index: 9999;
  }

  .drag-ghost {
    position:fixed;
    pointer-events:none;
    opacity:0.95;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    padding:6px;
    border-radius:8px;
    transform: translate(-50%,-50%);
    z-index: 9998;
    background: rgba(0,0,0,0.35);
  }

  .drop-options {
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    display:flex;
    gap:8px;
    padding:8px;
    border-radius:8px;
    background: rgba(20,20,20,0.95);
    border:1px solid #444;
    z-index: 9997;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  .drop-options.hidden { display:none; }
  .drop-options button {
    padding:6px 10px;
    border-radius:6px;
    background:#3a3a3a;
    color:#eee;
    border: none;
    cursor:pointer;
    min-width:44px;
    min-height:44px;
    font-weight:700;
  }
  .drop-options button:hover { background:#555; }

  /* small helper text */
  .legend { position: absolute; right:8px; top:8px; color:#999; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <div id="invA" class="inventory">
    <div class="legend">Inventory A</div>
    <!-- drop options (hidden by default) -->
    <div class="drop-options hidden" data-inv="A">
      <button data-mode="all">All</button>
      <button data-mode="half">Half</button>
      <button data-mode="1">1</button>
      <button data-mode="10">10</button>
      <button data-mode="100">100</button>
    </div>
  </div>

  <div id="invB" class="inventory">
    <div class="legend">Inventory B</div>
    <div class="drop-options hidden" data-inv="B">
      <button data-mode="all">All</button>
      <button data-mode="half">Half</button>
      <button data-mode="1">1</button>
      <button data-mode="10">10</button>
      <button data-mode="100">100</button>
    </div>
  </div>
</div>

<script>
// ------------------------------
// Utilities
// ------------------------------
function randomID(){
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  return Array.from({length:3},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
}
function colorFromID(id) {
  // Simple hash: turn the 3 letters into a hue 0â€“359
  let hash = 0;
  for (let i = 0; i < id.length; i++) {
    hash = (hash * 31 + id.charCodeAt(i)) % 360;
  }
  return `hsl(${hash} 70% 48%)`;
}

// ------------------------------
// Create items with quantities
// ------------------------------
function createItem(id, amount){

  const qty = (amount == null) ? Math.floor(Math.random()*120)+1 : amount;
  const div = document.createElement('div');
  div.className = 'item';

  div.dataset.id = id;
  div.textContent = id;
  div.style.background = colorFromID(id);

  // quantity badge
  const badge = document.createElement('span');
  badge.className = 'qty';
  badge.textContent = qty;
  div.appendChild(badge);

  div.dataset.qty = qty;

  return div;
}

const invA = document.getElementById('invA');
const invB = document.getElementById('invB');

for(let i=0;i<7;i++) invA.appendChild(createItem( randomID() ));
for(let i=0;i<7;i++) invB.appendChild(createItem( randomID() ));

// ------------------------------
// Selection & Drag State
// ------------------------------
let selection = new Set();
let isSelecting = false;
let selectionRect = null;
let dragData = null; // {items:Set, ghost:Element, originInv:Element}
let lastHoverInv = null;

// ------------------------------
// Helpers: sorting & cleanup
// ------------------------------
function sortInventory(inv){
  const items = Array.from(inv.querySelectorAll('.item'));
  items.sort((a,b) => a.textContent.localeCompare(b.textContent));
  items.forEach(it => inv.appendChild(it));
}

function cleanupEmptyItems(){
  document.querySelectorAll('.item').forEach(it => {
    if (parseInt(it.dataset.qty) <= 0) it.remove();
  });
}

// ------------------------------
// Drop options visibility
// ------------------------------
function hideAllDropOptions(){
  document.querySelectorAll('.drop-options').forEach(d => d.classList.add('hidden'));
  document.querySelectorAll('.inventory').forEach(i => i.classList.remove('highlight'));
  lastHoverInv = null;
}

function showDropOptionsFor(inv){
  hideAllDropOptions();
  const panel = inv.querySelector('.drop-options');
  if (!panel) return;
  panel.classList.remove('hidden');
  inv.classList.add('highlight');
  lastHoverInv = inv;
}

// ------------------------------
// Selection rectangle functions
// ------------------------------
document.addEventListener('pointerdown', e => {
  const target = e.target;
  // Start dragging on an item
  if (target.closest('.item')){
    const item = target.closest('.item');
    // If clicked item is not selected, clear selection and select it
    if (!selection.has(item)){
      clearSelection();
      selectItem(item);
    }
    startGroupDrag(e);
    return;
  }

  // Otherwise start selection rectangle
  clearSelection();
  isSelecting = true;
  selectionRect = document.createElement('div');
  selectionRect.id = 'selectionRect';
  selectionRect.style.left = e.clientX + 'px';
  selectionRect.style.top = e.clientY + 'px';
  selectionRect.startX = e.clientX;
  selectionRect.startY = e.clientY;
  document.body.appendChild(selectionRect);
});

document.addEventListener('pointermove', e => {
  // selection rectangle
  if (isSelecting && selectionRect){
    const x1 = selectionRect.startX;
    const y1 = selectionRect.startY;
    const x2 = e.clientX;
    const y2 = e.clientY;
    const left = Math.min(x1,x2), top = Math.min(y1,y2);
    const width = Math.abs(x1-x2), height = Math.abs(y1-y2);
    Object.assign(selectionRect.style, { left:left+'px', top:top+'px', width:width+'px', height:height+'px' });
    updateSelection(left, top, width, height);
  }

  // dragging group
  if (dragData){
    dragData.ghost.style.left = e.clientX + 'px';
    dragData.ghost.style.top = e.clientY + 'px';

    // Show/hide drop-options when hovering an inventory
    const inv = inventoryUnderPointer(e.clientX, e.clientY);
    if (inv) showDropOptionsFor(inv);
    else hideAllDropOptions();
  }
});

document.addEventListener('pointerup', e => {
  // finish rectangle selection
  if (isSelecting){
    isSelecting = false;
    if (selectionRect){ selectionRect.remove(); selectionRect = null; }
    return;
  }

  // drop the group: must drop onto a drop-option button inside an inventory
  if (dragData){
    // find element under pointer
    const el = document.elementFromPoint(e.clientX, e.clientY);
    const btn = el && el.closest('.drop-options button');
    const inv = el && el.closest('.inventory');

    if (btn && inv){
      const mode = btn.dataset.mode;
      applyQuantityTransfer(dragData.items, dragData.originInv, inv, mode);
    } else {
      // if not dropped onto a button, do nothing (snap back)
      // optional: you could append back to origin or leave where they were
    }

    // cleanup
    if (dragData.ghost) dragData.ghost.remove();
    dragData = null;
    hideAllDropOptions();
    cleanupEmptyItems();
    sortInventory(invA);
    sortInventory(invB);
    clearSelection();
  }
});

// ------------------------------
// Selection helpers
// ------------------------------
function clearSelection(){
  selection.forEach(it => it.classList.remove('selected'));
  selection.clear();
}
function selectItem(it){
  selection.add(it);
  it.classList.add('selected');
}
function updateSelection(left, top, width, height){
  const rect = {left, top, right: left+width, bottom: top+height};
  document.querySelectorAll('.item').forEach(it => {
    const b = it.getBoundingClientRect();
    const intersects = !(b.right < rect.left || b.left > rect.right || b.bottom < rect.top || b.top > rect.bottom);
    if (intersects) selectItem(it);
    else if (selection.has(it)) { it.classList.remove('selected'); selection.delete(it); }
  });
}

// ------------------------------
// Start group drag
// ------------------------------
function startGroupDrag(e){
  if (selection.size === 0) return;
  const ghost = document.createElement('div');
  ghost.className = 'drag-ghost';
  selection.forEach(it => {
    const clone = it.cloneNode(true);
    clone.style.width = '44px';
    clone.style.height = '44px';
    clone.style.fontSize = '10px';
    ghost.appendChild(clone);
  });
  document.body.appendChild(ghost);
  ghost.style.left = e.clientX + 'px';
  ghost.style.top = e.clientY + 'px';
  // record origin inventory (first selected item's parent)
  const originInv = Array.from(selection.values())[0].closest('.inventory');
  dragData = { items: new Set(selection), ghost, originInv };
}

// ------------------------------
// Inventory detection
// ------------------------------
function inventoryUnderPointer(x,y){
  const el = document.elementFromPoint(x,y);
  if (!el) return null;
  return el.closest('.inventory');
}

// ------------------------------
// Quantity transfer logic
// ------------------------------
function applyQuantityTransfer(itemsSet, fromInv, toInv, mode){
  // For each item being transferred, compute transfer amount and merge into destination
  itemsSet.forEach(item => {
    const id = item.dataset.id;
    console.log("Item: " + id);
    let qty = parseInt(item.dataset.qty,10) || 0;
    if (qty <= 0) return;

    let transfer = 0;
    switch(mode){
      case 'all': transfer = qty; break;
      case 'half': transfer = Math.max(1, Math.floor(qty/2)); break;
      case '1': transfer = Math.min(1, qty); break;
      case '10': transfer = Math.min(10, qty); break;
      case '100': transfer = Math.min(100, qty); break;
      default: transfer = 0;
    }

    if (transfer <= 0) return;

    // subtract from source
    qty -= transfer;
    item.dataset.qty = qty;
    item.querySelector('.qty').textContent = qty;

    // find existing item with same ID in destination
    const existing = Array.from(toInv.querySelectorAll('.item')).find(it => it.dataset.id === id);
    if (existing){
      const newQty = (parseInt(existing.dataset.qty,10) || 0) + transfer;
      existing.dataset.qty = newQty;
      existing.querySelector('.qty').textContent = newQty;
    } else {
      // clone element and set qty to transfer, then append
      const clone = createItem(id, transfer);

      // ensure qty label is correct (createItem set one)
      clone.querySelector('.qty').textContent = transfer;
      toInv.appendChild(clone);
    }
  });

  // optionally remove items with zero qty from source inventory
  Array.from(fromInv.querySelectorAll('.item')).forEach(it => {
    if (parseInt(it.dataset.qty,10) <= 0) it.remove();
  });
}

// ------------------------------
// Init: sort inventories initially
// ------------------------------
sortInventory(invA);
sortInventory(invB);


</script>
</body>
</html>
