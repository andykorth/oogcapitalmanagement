{{ $optimizeImg := .Page.Site.Params.optimizeImg | default true }}
{{ $url := urls.Parse .URL }}
{{ $altText := .Alt }}
{{ $caption := .Caption }}
{{ $style := .Style }}
{{ $size := .Size }}

{{ $excludeTypes := slice "svg" }}
{{ if not hugo.IsExtended }}
  {{ $excludeTypes = $excludeTypes | append "webp" }}
{{ end }}

{{ if $caption }}<figure>{{ end }}

{{ if not (findRE "^https?" $url.Scheme) }}
  {{ $imgResrc := .Page.Resources.GetMatch $url.String }}
  {{ if not $imgResrc }}
    {{ $imgResrc = resources.GetMatch $url.String }}
  {{ end }}

  {{ with $imgResrc }}
    {{ $originalWidth := .Width }}
    <img loading="lazy" {{ with $style }}class="{{ . }}"{{ end }}
    {{ if and $optimizeImg (not (in $excludeTypes .MediaType.SubType)) }}
      {{ if $size }}
        {{ $parsedSize := findRE `\d+` $size }}
        {{ $targetWidth := index $parsedSize 0 }}
        {{ if le $targetWidth $originalWidth }}
          src="{{ (.Fit $size).RelPermalink }}"
        {{ else }}
          src="{{ .RelPermalink }}"
        {{ end }}
      {{ else }}
        {{ with .Resize (printf "%dx%d webp q90" .Width .Height) }}
          src="{{ .RelPermalink }}" width="{{ .Width }}" height="{{ .Height }}"
        {{ end }}
      {{ end }}
    {{ else }}
      src="{{ .RelPermalink }}"
    {{ end }}
    alt="{{ $altText }}" />
  {{ end }}

{{ else }}
  <img loading="lazy" src="{{ $url.String }}" alt="{{ $altText }}" />
{{ end }}

{{ with $caption }}<figcaption>{{ . | markdownify }}</figcaption></figure>{{ end }}
