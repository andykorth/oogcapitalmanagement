<style>
    textarea {
        resize: none;
        width: 100%;
    }

    label {  
        display: block;
        margin-top: 1px;
    }

    #price-compare .inputs {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        max-width: 340px;
    }

    #price-compare select {
        padding: 4px 6px;
    }

    #priceTable {
        width: auto; /* override the 100% */
        min-width: 50%;
        margin-left: auto;
        margin-right: auto;
        margin-top: 1em;
        border-collapse: collapse;
    }

    #priceTable td, #priceTable th {
        border-bottom: 1px solid #ddd;
        padding: 4px 6px;
    }

    .expand-row {
        background: #f7f7f7;
    }

    .green-highlight {
        background-color: #d1fae5 !important; 
    }
    .dark .green-highlight {
        background-color: #002c15 !important; 
    }

  .expand-details-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }

  table {
    table-layout: fixed;
    max-width: 100%;     /* prevents expanding past container */
  }

  .expand-details-table th,
  .expand-details-table td {
    border: 1px solid #ddd;
    padding: 4px 6px;
    vertical-align: middle;
  }

  .expand-details-table a {
    color: inherit;
    text-decoration: none;
  }

  [data-tooltip]:hover::after {
    display: block;
    position: absolute;
    content: attr(data-tooltip);
    border: 1px solid black;
    background: var(--bg-primary);
    padding: .25em;
  }

  .sell-text {
    color: #b91c1c;
    font-weight: bold;
  }
  .dark .sell-text {
    color: #fca5a5; 
  }

  .buy-text {
    color: #065f46;
    font-weight: bold;
  }
  .dark .buy-text {
    color: #6ee7b7; 
  }

  .self-text {
    text-decoration: underline;
    font-weight: bold;
  }
  .dark .self-text {
    text-decoration: underline;
    font-weight: bold;
  }



  .sell-text,
  .buy-text {
    white-space: nowrap;        /* never wrap */
    overflow: hidden;           /* hide anything too long */
    text-overflow: ellipsis;    /* optional: "..." at end */
    display: block;             /* or inline-block; needed for overflow rules */
    max-width: 100%;            /* ensures it respects parent container width */
  }

  .info-icon {
    cursor: help;
    font-size: 14px;
    padding: 2px;
  }

  .col-check {
    width: 32px;        /* small, tight */
    text-align: center;
  }

  .col-info {
    width: 32px;
    text-align: center;
  }

  .col-expand {
    width: 60px;        /* enough for the button */
    text-align: center;
  }

  /* Make sure cells don't stretch */
  .col-check input,
  .col-info span,
  .col-expand button {
    display: inline-block;
  }

</style>

<div id="price-compare" class="calculator">
  <h3>Price Comparison Tool</h3>

  <div class="inputs">
    <label>
      Filter by Exchange:
      <select id="exchangeFilter">
        <option value="ALL">All</option>
        <option value="AI1">AI1</option>
        <option value="CI1">CI1</option>
        <option value="CI2">CI2</option>
        <option value="IC1">IC1</option>
        <option value="NC1">NC1</option>
        <option value="NC2">NC2</option>
      </select>
    </label>

    <label>
      Filter by Material:
      <input type="text" id="materialFilter" placeholder="e.g. H2O">
    </label>

    <label>
      <input type="checkbox" id="hideNoPrices">
      Hide materials with no prices
    </label>

    <label>
      Show:
      <select id="bidAskSelect">
        <option value="bids">Show bids</option>
        <option value="asks">Show asks</option>
      </select>
    </label>

    <label>
      Percent Markup over Modeled (%):
      <input type="number" id="markupInput" value="4" step="0.1">
    </label>

    <div id="actionModeFields">

      <label>
        Available Funds for trade:
        <input type="number" id="fundsInput" value="10000000" min="0">
      </label>
      
      <label>
        Min Percent Spread (%):
        <input type="number" id="minSpreadInput" value="6" step="0.1">
      </label>

      <label>
        Min Volume to Trade On: (in $)
        <input type="number" id="minVol" value="" min="0">
      </label>
      <label>
        Max Volume to Trade On: (in $)
        <input type="number" id="maxVol" value="" min="0">
      </label>
      <label>
        Your company code
        <input type="text" id="companyCode" value="ARCL">
      </label>

      
    </div>

    <button id="loadPrices" class="">
      Load Comparison Data
    </button>

    <p id="calculatorStatus" style="font-weight: bold; margin-top: 0.5rem;"></p>
  </div>

  <table id="priceTable" style="display: none;">
    <thead id="priceHead"></thead>
    <tbody id="priceBody"></tbody>
  </table>
</div>

<script type="module">
  import { fetchFullCXData, fullCXData } from "/pricing-and-materials.js";
  import { loadModeledPrices, modeledPrices } from "/pricing-and-materials.js";

  const btn = document.getElementById("loadPrices");
  const status = document.getElementById("calculatorStatus");
  const table = document.getElementById("priceTable");
  const thead = document.getElementById("priceHead");
  const tbody = document.getElementById("priceBody");

  const exchangeFilter = document.getElementById("exchangeFilter");
  const markupInput = document.getElementById("markupInput");
  const materialFilter = document.getElementById("materialFilter");
  const hideNoPrices = document.getElementById("hideNoPrices");
  const bidAskSelect = document.getElementById("bidAskSelect");
  const fundsInput = document.getElementById("fundsInput");
  const minSpreadInput = document.getElementById("minSpreadInput");
  const actionModeFields = document.getElementById("actionModeFields");


  exchangeFilter.addEventListener("change", () => {
    if (exchangeFilter.value === "ALL") {
      actionModeFields.style.display = "none";
    } else {
      actionModeFields.style.display = "";
    }
  });

  materialFilter.addEventListener("input", () => {
    const q = materialFilter.value.trim().toUpperCase();

    for (const row of tbody.querySelectorAll("tr[id^='row-']")) {
      const mat = row.id.replace("row-", "");
      const match = mat.includes(q);
      row.style.display = match ? "" : "none";

      const expandRow = document.getElementById(`expand-${mat}`);
      if (expandRow) expandRow.style.display = match ? "none" : "none";
    }
  });

  [
    exchangeFilter,
    markupInput,
    hideNoPrices,
    bidAskSelect,
    fundsInput
  ].forEach(el => {
    el.addEventListener("input", renderTable);
    el.addEventListener("change", renderTable);
  });

  btn.addEventListener("click", async () => {
    status.textContent = "Loading…";

  await fetchFullCXData(status);
    loadModeledPrices();
    renderTable();
  });

    
async function renderTable() {

  if (!fullCXData.length) {
    status.textContent = "No exchange data available.";
    return;
  }

  const markupPct = Number(markupInput.value) / 100;
  const filterEx = exchangeFilter.value;

  const userMinVol = Number(document.getElementById("minVol").value || 0);
  const userMaxVol = Number(document.getElementById("maxVol").value || Infinity);
  const userCompany = document.getElementById("companyCode").value.trim().toUpperCase();

  // Exchanges allowed in table
  const exchangeCodes = [...new Set(fullCXData.map(r => r.ExchangeCode))]
    .sort()
    .filter(ex => filterEx === "ALL" || ex === filterEx);

  // Unique materials
  const materials = [...new Set(fullCXData.map(r => r.MaterialTicker))].sort();

  // Build header (add checkbox column)
  let headHTML = "";
  if (filterEx !== "ALL") {
    headHTML += `<th class="col-check">✔</th>`;
    headHTML += `<th class="col-info">?</th>`;
  }

   headHTML += "<th>Material</th>";

  for (const ex of exchangeCodes) headHTML += `<th>${ex}</th>`;
  headHTML += `<th>Modeled</th><th class="col-expand">Expand</th></tr>`;
  thead.innerHTML = headHTML;

  // prepare pricedata
  const showBids = bidAskSelect.value === "bids";
  const priceMap = {};
  const volumeMap = {};          // NEW — tracks each row's VolumeAmount
  const fullOrderData = {};

  for (const row of fullCXData) {
    const ticker = row.MaterialTicker;
    const ex = row.ExchangeCode;

    if (!priceMap[ticker]) priceMap[ticker] = {};
    if (!volumeMap[ticker]) volumeMap[ticker] = {};
    if (!fullOrderData[ticker]) fullOrderData[ticker] = {};
    if (!fullOrderData[ticker][ex]) {
      fullOrderData[ticker][ex] = {
        buying: row.BuyingOrders || [],
        selling: row.SellingOrders || []
      };
    }

    let selectedPrice = null;

    if (showBids && Array.isArray(row.BuyingOrders)) {
      for (const bo of row.BuyingOrders) {
        if (typeof bo.ItemCost === "number") {
          if (selectedPrice === null || bo.ItemCost > selectedPrice)
            selectedPrice = bo.ItemCost;
        }
      }
    }

    if (!showBids && Array.isArray(row.SellingOrders)) {
      for (const so of row.SellingOrders) {
        if (typeof so.ItemCost === "number") {
          if (selectedPrice === null || so.ItemCost < selectedPrice)
            selectedPrice = so.ItemCost;
        }
      }
    }

    if (selectedPrice !== null) {
      priceMap[ticker][ex] = selectedPrice;
      volumeMap[ticker][ex] = row.VolumeAmount ?? 0;
    }
  }

  // Build body
  let bodyHTML = "";

  for (const mat of materials) {
    const modeled = modeledPrices[mat];
    const threshold = modeled ? modeled * (1 - markupPct) : null;
    const hasAnyPrice = exchangeCodes.some(ex => priceMap[mat]?.[ex] !== undefined);

    if (hideNoPrices.checked && !hasAnyPrice) continue;

    // Determine highlight & auto-check logic
    let highlightRow = false;
    let explanation = "";

    if (filterEx !== "ALL") {
      const p = priceMap[mat]?.[ex];
      const vol = volumeMap[mat]?.[ex];

      if (p !== undefined && modeled !== undefined) {
        const underModeled = p <= threshold;
        const volOK = vol >= userMinVol && vol <= userMaxVol;

        // Find highest buying order to check company skip condition
        let highestBO = null;
        const buying = fullOrderData[mat]?.[filterEx]?.buying || [];
        if (buying.length > 0) {
          highestBO = buying.reduce((a, b) =>
            a.ItemCost > b.ItemCost ? a : b
          );
        }

        const hasHighBidAlready =
          highestBO && highestBO.CompanyCode?.toUpperCase() === userCompany.toUpperCase() ;

        highlightRow = underModeled && volOK && !hasHighBidAlready;

        if(underModeled){
          if(!volOK){
            explanation += `Outside cash volume params:  $${vol} traded is outside your $${userMinVol} .. $${userMaxVol}`;
          }
          if(hasHighBidAlready){
            explanation += `You already have high bid.`;
          }
        }
      }
    }

    bodyHTML += `<tr id="row-${mat}" class="${highlightRow ? "green-highlight" : ""}">`;


    // Checkbox column (checked if highlighted) and explanation column
    if (filterEx !== "ALL"){
      bodyHTML += `<td class="col-check"><input type="checkbox" class="rowCheck" data-mat="${mat}" ${highlightRow ? "checked" : ""}></td>`;
      const expl = explanation === "" ? "" : `<span class="info-icon" title="${explanation}">ℹ️</span>`;
      bodyHTML += `<td class="col-info">${expl}</td>`;
    }

    bodyHTML += `<td>${mat}</td>`;

    // draw (and highlight) individual cells for for each exchange selected
    for (const ex of exchangeCodes) {
      const p = priceMap[mat]?.[ex];
      const cellCls = filterEx == "ALL" && ( p !== undefined ? 'class="green-highlight"' : "");
      bodyHTML += `<td ${cellCls}>${p !== undefined ? p.toLocaleString() : ""}</td>`;
    }

    bodyHTML += `<td>${modeled !== undefined ? modeled.toLocaleString() : ""}</td>`;
    bodyHTML += `<td class="col-expand"><button data-mat="${mat}" class="expandBtn">Orders</button></td></tr>`;

    // Expandable row
    bodyHTML += `
    <tr id="expand-${mat}" class="expand-row" style="display:none;">
      <td colspan="${exchangeCodes.length + 4}">
        <div id="expand-content-${mat}"></div>
      </td>
    </tr>`;
  }

  tbody.innerHTML = bodyHTML;
  table.style.display = "";
  status.textContent = `Loaded ${materials.length} materials across ${exchangeCodes.length} exchanges.`;

  // Expand handlers 
  document.querySelectorAll(".expandBtn").forEach(btn => {
    btn.addEventListener("click", e => {
      addExpandContent(e, exchangeCodes, fullOrderData, userCompany)
    });
  });
}

function addExpandContent(e, exchangeCodes, fullOrderData, userCompany){
  const mat = e.target.dataset.mat;
  const row = document.getElementById(`expand-${mat}`);
  const content = document.getElementById(`expand-content-${mat}`);

  if (row.style.display === "none") {
    row.style.display = "";

    let html = `<table class="expand-details-table"><tr>`;
    for (const ex of exchangeCodes) html += `<th>${ex}</th>`;
    html += "</tr><tr>";

    for (const ex of exchangeCodes) {
      const data = fullOrderData[mat]?.[ex];
      if (!data) {
        html += "<td>(no data)</td>";
        continue;
      }

      let cell = "";

      data.selling.sort((a, b) => b.ItemCost - a.ItemCost);
      for (const so of data.selling) {
        cell += generateOrderText("sell-text", so, userCompany);
      }

      data.buying.sort((a, b) => b.ItemCost - a.ItemCost);
      for (const bo of data.buying) {
        cell += generateOrderText("buy-text", bo, userCompany);
      }

      if (cell === "") cell = "(none)";
      html += `<td>${cell}</td>`;
    }

    html += "</tr></table>";
    content.innerHTML = html;
  } else {
    row.style.display = "none";
  }
}

function generateOrderText(cssType, o, userCode){
  const count = o.ItemCount === null ? "∞" : o.ItemCount.toLocaleString();
  const cssSpan = o.CompanyCode == userCode ? "self-text" : "";
  const companyLink = `<A HREF="/intel/?co=${o.CompanyCode}" data-tooltip="${o.CompanyName}"  >${o.CompanyCode}</A>`;
  return `<div class="${cssType}">${o.ItemCost.toLocaleString()} × ${count} - <span class="${cssSpan}">${companyLink}</span></div>`;
}

</script>
