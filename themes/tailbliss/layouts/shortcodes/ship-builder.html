<style>
#ship-builder-root .input-row label {
	flex: 0 0 130px;
	text-align: right;
	margin-right: 0.5rem;
	display: inline;
	min-width: 130px;
}

#ship-builder-root .inputs {
	display: flex;
	flex-direction: column;
	align-items: flex-start;
	gap: 0.8rem;
}
</style>

<div id="ship-builder-root" class="space-y-6">

	<h1>Current Inventory:</h1>

  <label><input id="onlyShowPublicShips" type="checkbox" checked /> Only show public ships</label>

  <div class="two-col">
		<div class="col">
			<div id="inventoryAge" class="text-sm text-gray-600"></div>

			<div id="ship-summary-root" class="mb-4"></div>

		</div>
		<div class="col">
			<div id="ship-detail" class="mb-4"></div>

		</div>

	</div>

	<h1>Inventory Details:</h1>

	<p class="text-sm text-gray-600">
		This section is used by OOG ship builders to order the additional parts to reach the desired ship count. Missing materials will be calculated from ANT + Hephaestus only.
	</p>
	<p class="text-sm text-gray-600">
		Select the ship type to filter inventory to that blueprint, otherwise all ship parts will be shown.
	</p>
  <section class="inputs">
    <div class="input-row">
      <label for="shipSelect" class="font-semibold">
        Ship Blueprint
      </label>
      <select id="shipSelect" class="border px-2 py-1">
        <!-- options filled by JS -->
      </select>

    </div>

    <div class="input-row">
      <label for="desiredCount" class="block font-semibold">
        Desired ship count
      </label>
      <input
        id="desiredCount"
        type="number"
        min="1"
        class="border px-2 py-1 w-48"
        placeholder="Leave blank to disable"
      />
    </div>

    <div id="buildResult" class="font-bold"></div>
  </section>

  <!-- Table goes here -->
  <section id="inventoryTableContainer"></section>

<button class="copy-order-btn" disabled>
  Copy OOG Parts /projects order to clipboard
</button>

</div>

<div id="ship-image-modal" class="ship-image-modal hidden">
  <div class="ship-image-backdrop" onclick="closeShipImageModal()"></div>
  <img id="ship-image-modal-img" />
</div>

<script type="module">

let select;

const SHIP_RECIPES = {
  "OOG Premium 2k": {
    name: "OOG Premium 2k",
    price: 6150000,
    internalSalesOnly: false,
    imageUrl: "/shipbuilding/OOG2k2025.png",

    parts: {
      SSC: 128,
      LHP: 94,
      LFE: 2,
      MFE: 2,
      LFL: 1,
      MSL: 1,
      SFE: 1,
      LCB: 1,
      FSE: 1,
      QCR: 1,
      CQM: 1,
      BR1: 1,
      FFC: 1
    }
  },
  "5k Shields": {
    name: "5k Shields",
    price: 19700000,
    internalSalesOnly: false,
    imageUrl: "/shipbuilding/shielded5k.png",
    parts: {

		SSC: 284,
		AHP: 159,
		APT: 159,
		AWH: 159,
		SRP: 159,
		LFE: 5,
		MFE: 2,
		SFE: 2,
		BR2: 1,
		CQL: 1,
		FSE: 1,
		HYR: 1,
		HCB: 1,
		LFL: 1,
		MSL: 1,
		RDL: 1,
		FFC: 1,
		STS: 1
	}
  },

  "5k Unshielded": {
    name: "5k Unshielded",
    price: 11500000,
    internalSalesOnly: false,
    imageUrl: "/shipbuilding/5kUnshielded.png",

    parts: {
      SSC: 278,
      LHP: 157,
      BR1: 1,
      CQL: 1,
      FFC: 1,
      FSE: 1,
      HCB: 1,
      LFE: 5,
      MFE: 2,
      SFE: 1,
      LFL: 1,
      MSL: 1,
      QCR: 1,
      STS: 1
	}
  },

  "2k All Shields": {
    name: "2k All Shields",
    price: 10997000,
    internalSalesOnly: false,
    imageUrl: "/shipbuilding/shielded_2k.png",

    parts: {
		SSC: 128,
		AHP: 94,
		APT: 94,
		AWH: 94,
		SRP: 94,
		LFE: 2,
		MFE: 2,
		SFE: 1,
		BR1: 1,
		CQM: 1,
		FFC: 1,
		FSE: 1,
		LCB: 1,
		LFL: 1,
		MSL: 1,
		QCR: 1,
		RDL: 1,
		STS: 1
	}
  },
  "OOG New WCB": {
    name: "OOG New WCB",
    price: 5900000,
    internalSalesOnly: true,
    imageUrl: "/shipbuilding/oog-new-wcb.png",

    parts: {

    SSC: 84,
    LHP: 71,
    MFE: 2,
    LFE: 1,
    LFL: 1,
    MSL: 1,
    SFE: 2,
    FSE: 1,
    HYR: 1,
    CQM: 1,
    BR2: 1,
    FFC: 1,
    STS: 1,
    WCB: 1
	}
  },

  "5k STL HCB": {
    name: "5k STL HCB",
    price: 7800000,
    internalSalesOnly: true,
    imageUrl: "/shipbuilding/5k-stl-hcb.png",

    parts: {
      SSC: 265,
      LHP: 152,
      HCB: 1,
      FSE: 1,
      CQL: 1,
      BRS: 1,
      SSL: 1,
    }
  },

  "OOG Gas Hauler": {
    name: "OOG Gas Hauler",
    price: 7600000,
    internalSalesOnly: true,
    imageUrl: "/shipbuilding/oog-gas-hauler.png",

    parts: {

    SSC: 178,
    LHP: 117,
    LFE: 3,
    MFE: 2,
    SFE: 1,
    LFL: 1,
    MSL: 1,
    VCB: 1,
    FSE: 1,
    QCR: 1,
    CQL: 1,
    BR1: 1,
    FFC: 1,
    STS: 1
	}
  },

  "Colony Ship": {
    name: "Colony Ship",
    price: 34800000,
    internalSalesOnly: false,
    imageUrl: "/shipbuilding/colony-ship-blueprint.png",

    parts: {
      SSC: 406,
      AHP: 202,
      APT: 202,
      AWH: 202,
      SRP: 202,
      HAM: 1,
      BR2: 1,
      CQL: 1,
      AGS: 1,
      HTE: 1,
      VOR: 1,
      HCB: 1,
      VFT: 1,
      LSL: 1,
      RDL: 1,
      STS: 1
	}
  }
};

const SHIP_PART_PRICES = {
  MFL: 140000,
  LFL: 300000,
  MSL: 140000,
  LSL: 300000,
  LFE: 170000,
  MFE: 90000,
  SFE: 60000,
  LHP: 3900,
  SSC: 500,
  LCB: 600000,
  VCB: 650000,
  WCB: 650000,
  HCB: 3750000,
  FSE: 900000,
  QCR: 900000,
  CQM: 950000,
  CQL: 1800000,
  BR1: 800000,
  BR2: 950000,
  FFC: 350000,
  BRS: 400000,
  CQS: 750000,
  CQT: 200000,
  GEN: 150000,
  AGS: 400000,
  BGS: 150000,
  SFL: 30000,
  SSL: 30000,
  SCB: 80000,
  STS: 175000,
  RDL: 800000,
  RDS: 400000,
  HPR: 900000,
  HYR: 1700000,
  AEN: 1500000,
  HTE: 3000000,
  RCT: 900000,
  AHP: 10000,
  AWH: 13000,
  APT: 14000,
  SRP: 10000,
  HAM: 6000000,
  VOE: 5000000
};


const SHIP_PART_TICKERS = new Set([
  'MFL', 'LFL', 'MSL', 'LSL', 'LFE', 'MFE', 'SFE', 'LHP', 'SSC', 'LCB', 'VCB', 
  'WCB', 'HCB', 'FSE', 'QCR', 'CQM', 'CQL', 'BR1', 'BR2', 'FFC', 'BRS', 'CQS', 
  'CQT', 'GEN', 'AGS', 'BGS', 'SFL', 'SSL', 'SCB', 'STS', 'RDL', 'RDS', 'HPR', 
  'HYR', 'AEN', 'HTE', 'RCT', 'AHP', 'AWH', 'APT', 'SRP', 'HAM', 'VOR', 'VFT'
]);

let appState = {
  users: {},          // { username: { inventory, byLocation } }
  selectedShip: null,
  desiredCount: null
};

const root = document.getElementById("ship-builder-root");
const shipSelect = document.getElementById("shipSelect");
const desiredInput = document.getElementById("desiredCount");
const resultEl = document.getElementById("buildResult");
const ageEl = document.getElementById("inventoryAge");
const tableContainer = document.getElementById("inventoryTableContainer");
const shipDetailContainer = document.getElementById("ship-detail");
const onlyShowPublicShips = document.getElementById("onlyShowPublicShips");
const copyButton = document.querySelector(".copy-order-btn");

const INVENTORY_API_KEY = "4a07e526-b678-4f17-8858-39d80ab2d413";

function buildInventoryUrl(username) {
  return `https://rest.fnar.net/csv/inventory?apikey=${INVENTORY_API_KEY}&username=${username}`;
}


// Add "None" option first
const noneOpt = document.createElement("option");
noneOpt.value = "";
noneOpt.textContent = "None (Show All Materials)";
shipSelect.appendChild(noneOpt);

for (const shipName of Object.keys(SHIP_RECIPES)) {
  const opt = document.createElement("option");
  opt.value = shipName;
  opt.textContent = shipName;
  shipSelect.appendChild(opt);
}

async function fetchInventoryForUser(username) {
  const cacheKey = `ship_inventory_cache_${username}`;
  const TTL = 30 * 60 * 1000; // 30 min

  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      const { timestamp, data } = JSON.parse(cached);
      if (Date.now() - timestamp < TTL) {
        return {
          inventory: new Map(data.inventory),
          byLocation: new Map(data.byLocation), 
          timestamp
        };
      }
    } catch {}
  }

  const response = await fetch(buildInventoryUrl(username));
  const csv = await response.text();
  const processed = processData(csv);

  localStorage.setItem(cacheKey, JSON.stringify({
    timestamp: Date.now(),
    data: {
      inventory: [...processed.inventory.entries()],
      byLocation: [...processed.byLocation.entries()]
    }
  }));

  return {
    ...processed,
    timestamp: Date.now()
  };
}

const formatInventoryAge = () => {
  const cacheKey = "ship_inventory_cache_Archiel";
  const cached = localStorage.getItem(cacheKey);
  if (!cached) return null;

  try {
    const { timestamp } = JSON.parse(cached);
    const ageMs = Date.now() - timestamp;

    const seconds = Math.floor(ageMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);

    if (hours > 0) return `${hours} hour${hours !== 1 ? "s" : ""} ago`;
    if (minutes > 0) return `${minutes} minute${minutes !== 1 ? "s" : ""} ago`;
    return `${seconds} second${seconds !== 1 ? "s" : ""} ago`;
  } catch {
    return null;
  }
};

const renderShipSummaryTable = () => {
  const root = document.getElementById("ship-summary-root");
  root.innerHTML = "";

  if (!appState.users["Archiel"].byLocation) return;

  const table = document.createElement("table");
  table.className = "table-auto border-collapse text-sm";

  table.innerHTML = `
    <thead>
      <tr>
        <th class="text-left pr-4">Ship Design</th>
        <th class="text-right">In Stock</th>
        <th class="text-right pr-4">Cost</th>
      </tr>
    </thead>
  `;

  const tbody = document.createElement("tbody");

  for (const shipName of Object.keys(SHIP_RECIPES)) {
    const recipe = SHIP_RECIPES[shipName];

    if(recipe.internalSalesOnly && onlyShowPublicShips.checked){
      continue;
    }

    const count = calculateBuildCount(appState.users["Archiel"].byLocation, recipe.parts);

    const tr = document.createElement("tr");
    tr.classList.add("ship-row");
    tr.addEventListener("click", () => {
      shipSelect.value = shipName;
      renderInventoryTable();
    });
    tr.innerHTML = `
        <td class="pr-4">${shipName}</td>
        <td class="text-right font-mono">${count.toLocaleString()}</td>
        <td class="pr-4">${recipe.price.toLocaleString()} AIC</td>
      `;

    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  root.appendChild(table);
};


const renderInventoryTable = () => {
  const selectedShip = shipSelect.value || null;
  const desiredCount = parseInt(desiredInput.value, 10) || null;

  const table = createTable(
    appState.users,
    selectedShip,
    desiredCount
  );

  tableContainer.querySelector("table")?.remove();
  tableContainer.appendChild(table);


  if (!selectedShip || selectedShip === ""){
    resultEl.textContent = "Showing all ship parts.";
  }else{
    const recipe = SHIP_RECIPES[selectedShip]?.parts;
    const buildCount = calculateBuildCount(appState.users["Archiel"].byLocation, recipe);

    resultEl.textContent = `Archiel has parts for ${buildCount.toLocaleString()} x ${selectedShip}`;
  }

  renderShipDetails(selectedShip)
};

function renderShipDetails(selectedShip) {
  if (!selectedShip || selectedShip === "") {
    selectedShip = "OOG Premium 2k";
  }

  const ship = SHIP_RECIPES[selectedShip];
  const recipe = ship.parts;
  const buildCount = calculateBuildCount(appState.users["Archiel"].byLocation, recipe);

  const priceText = ship.price
    ? ship.price.toLocaleString() + " AIC"
    : "Price unavailable";

  const stockStatus =
    buildCount === 0
      ? `<span class="ship-status out">Out of stock</span>`
      : `<span class="ship-status in">In stock</span>`;

  const internalNote = ship.internalSalesOnly
    ? `<div class="ship-note">Not for public sale â€” internal only</div>`
    : "";

  const buildCountNote = buildCount > 0
    ? `<div class="ship-build-count">Quantity in Stock: ${buildCount.toLocaleString()}</div>`
    : "";

  shipDetailContainer.innerHTML = `
    <div class="ship-card">
      <div class="ship-card-info">
        <div class="ship-title">${ship.name}</div>
        <div class="ship-price">${priceText}</div>
        ${stockStatus}
        ${internalNote}
        ${buildCountNote}
      </div>
		<div class="ship-card-image">
		<img 
			src="${ship.imageUrl}" 
			alt="${ship.name}" 
			class="ship-preview-image"
			onclick="openShipImageModal('${ship.imageUrl}', '${ship.name}')"
		>
		</div>
    </div>
  `;
}


shipSelect.addEventListener("change", renderInventoryTable);
desiredInput.addEventListener("input", renderInventoryTable);
onlyShowPublicShips.addEventListener("input", renderShipSummaryTable);


const calculateBuildCount = (byLocation, parts) => {
  let maxBuilds = Infinity;

  for (const [ticker, required] of Object.entries(parts)) {

	const loc = byLocation.get(ticker) || {};

	const ant = loc["ANT"] || 0;
	const hep = loc["ZV-307c"] || 0;
	const available = ant + hep;
    maxBuilds = Math.min(maxBuilds, Math.floor(available / required));
  }

  return Number.isFinite(maxBuilds) ? maxBuilds : 0;
};

const computeMissing = (ticker, available, recipe, desiredCount) => {
  if (!desiredCount || !recipe) return "";

  const perShip = recipe[ticker];
  if (!perShip) return ""; // material not used by this ship

  const needed = perShip * desiredCount;
  const missing = Math.max(needed - available, 0);

  return missing ? missing.toLocaleString() : "";
};

function buildOrderString(missing) {
  return Object.entries(missing)
    .filter(([_, qty]) => qty > 0)
    .map(([ticker, qty]) => {
      const price = SHIP_PART_PRICES[ticker] ?? 0;
      return `${qty} ${ticker}@${price}AIC/u`;
    })
    .join(",");
}

function setupCopyButton(button, allMissing) {

	const hasMissing = Object.values(allMissing).some(qty => qty > 0);
	button.disabled = !hasMissing;

	if (!hasMissing) return;

	const orderText = Object.entries(allMissing)
		.map(([ticker, qty]) => {
			const price = SHIP_PART_PRICES[ticker] ?? 0;
			return `${qty} ${ticker}@${price}AIC/u`;
		})
		.join(",");

	button.onclick = async () => {
		try {
			await navigator.clipboard.writeText(orderText);

			const oldText = button.textContent;
			button.textContent = "Copied!";

			setTimeout(() => {
				button.textContent = oldText;
			}, 1200);

		} catch (err) {
			console.error("Clipboard copy failed", err);
		}
	};
}


const processData = (csvData) => {
  const inventory = new Map();
  const byLocation = new Map();

  const rows = csvData.trim().split('\n');
  const header = rows.shift().trim().split(',');

  const tickerIndex = header.indexOf('Ticker');
  const amountIndex = header.indexOf('Amount');
  const locationIndex = header.indexOf('NaturalId');

  for (const row of rows) {
    const values = row.split(',');
    const ticker = values[tickerIndex];
    const amount = parseInt(values[amountIndex], 10);
    const location = values[locationIndex];

    if (!SHIP_PART_TICKERS.has(ticker)) continue;

    // total
    inventory.set(ticker, (inventory.get(ticker) || 0) + amount);

    // by location
    if (!byLocation.has(ticker)) byLocation.set(ticker, {});
    byLocation.get(ticker)[location] =
      (byLocation.get(ticker)[location] || 0) + amount;
  }

  return { inventory, byLocation };
};


const createTable = (users, selectedShip, desiredCount) => {

	const table = document.createElement('table');
	table.style = 'width:400px';

	table.innerHTML = `
	<thead>
		<tr>
		<th>Ticker</th>
		<th>Total (Archiel)</th>
		<th>ANT</th>
		<th>Hephaestus</th>
    <th>ANT (MrSmith33)</th>
		<th>Missing</th>
		</tr>
	</thead>
	`;

	const recipe = selectedShip ? SHIP_RECIPES[selectedShip].parts : null;

	const sorted = selectedShip
		? Object.keys(recipe).sort()
		: [...users["Archiel"].inventory.keys()].sort();

	const tbody = document.createElement("tbody");

	// Collect missing totals across ALL tickers
	const allMissing = {};

	for (const ticker of sorted) {
    const archiel = users["Archiel"];
    const smith = users["MrSmith33"];

    const total = archiel.inventory.get(ticker) || 0;

    const archLoc = archiel.byLocation.get(ticker) || {};
    const smithLoc = smith.byLocation.get(ticker) || {};

    const antArch = archLoc["ANT"] || 0;
    const hep = archLoc["ZV-307c"] || 0;
    const antSmith = smithLoc["ANT"] || 0;

    // Missing still based ONLY on Archiel (unless you want combined)
    const available = antArch + hep;

		const missing = computeMissing(
			ticker,
			available,
			recipe,
			desiredCount
		);

		if (missing > 0) {
			allMissing[ticker] = missing;
		}

		const tr = document.createElement("tr");
		tr.innerHTML = `
			<td>${ticker}</td>
			<td>${total.toLocaleString()}</td>
			<td>${antArch.toLocaleString()}</td>
			<td>${hep.toLocaleString()}</td>
      <td>${antSmith.toLocaleString()}</td>
			<td>${missing}</td>
		`;
		tbody.appendChild(tr);
	}

	table.appendChild(tbody);

	// Setup copy button ONCE using aggregated missing list
	setupCopyButton(copyButton, allMissing);

	return table;
};

document.addEventListener("DOMContentLoaded", async () => {
  root.classList.add("opacity-50");
  resultEl.textContent = "Loading inventory data...";

  const usernames = ["Archiel", "MrSmith33"];

  const results = await Promise.all(
    usernames.map(u => fetchInventoryForUser(u))
  );

  usernames.forEach((username, i) => {
    appState.users[username] = results[i];
  });

  ageEl.textContent = `Inventory data from ${formatInventoryAge()}`;

  root.classList.remove("opacity-50");

  renderShipSummaryTable();
  renderInventoryTable();
});


window.openShipImageModal = (src, alt) => {
  const modal = document.getElementById("ship-image-modal");
  const img = document.getElementById("ship-image-modal-img");

  img.src = src;
  img.alt = alt;

  modal.classList.remove("hidden");
};

window.closeShipImageModal = () => {
  document.getElementById("ship-image-modal").classList.add("hidden");
};

// Close on ESC
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeShipImageModal();
});


</script>