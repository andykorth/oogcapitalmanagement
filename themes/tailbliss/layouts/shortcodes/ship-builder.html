
<div id="ship-builder-root" class="space-y-6">

  <!-- Controls -->
  <section class="space-y-4">
    <div>
      <label for="shipSelect" class="block font-semibold">
        Ship model
      </label>
      <select id="shipSelect" class="border px-2 py-1">
        <!-- options filled by JS -->
      </select>
      <p class="text-sm text-gray-600">
        Select the ship type you want to build.
      </p>
    </div>

    <div>
      <label for="desiredCount" class="block font-semibold">
        Desired ship count
      </label>
      <input
        id="desiredCount"
        type="number"
        min="1"
        class="border px-2 py-1 w-48"
        placeholder="Leave blank to disable"
      />
      <p class="text-sm text-gray-600">
        When set, missing materials will be calculated from ANT + Hephaestus only.
      </p>
    </div>

    <div id="buildResult" class="font-bold"></div>
    <div id="inventoryAge" class="text-sm text-gray-600"></div>
  </section>

  <!-- Table goes here -->
  <section id="inventoryTableContainer"></section>

</div>


<script type="module">

const root = document.getElementById("ship-builder-root");
const shipSelect = document.getElementById("shipSelect");
const desiredInput = document.getElementById("desiredCount");
const resultEl = document.getElementById("buildResult");
const ageEl = document.getElementById("inventoryAge");
const tableContainer = document.getElementById("inventoryTableContainer");
let select;

const SHIP_RECIPES = {
  "Standard 2k": {
    SSC: 128,
    LHP: 94,
    LFE: 2,
    MFE: 2,
    LFL: 1,
    MSL: 1,
    SFE: 1,
    LCB: 1,
    FSE: 1,
    QCR: 1,
    CQM: 1,
    BR1: 1,
    FFC: 1
  },
  "5k Shields": {
    SSC: 284,
    AHP: 159,
    APT: 159,
    AWH: 159,
    SRP: 159,
    MFE: 2,
    LFE: 5,
    SFE: 2,
    BR2: 1,
    CQL: 1,
    FFC: 1,
    FSE: 1,
    HYR: 1,
    HCB: 1,
    LFL: 1,
    MSL: 1,
    RDL: 1,
    STS: 1
  }
};


const SHIP_PART_TICKERS = new Set([
  'MFL', 'LFL', 'MSL', 'LSL', 'LFE', 'MFE', 'SFE', 'LHP', 'SSC', 'LCB', 'VCB', 
  'WCB', 'HCB', 'FSE', 'QCR', 'CQM', 'CQL', 'BR1', 'BR2', 'FFC', 'BRS', 'CQS', 
  'CQT', 'GEN', 'AGS', 'BGS', 'SFL', 'SSL', 'SCB', 'STS', 'RDL', 'RDS', 'HPR', 
  'HYR', 'AEN', 'HTE', 'RCT', 'AHP', 'AWH', 'APT', 'SRP'
]);

let appState = {
  inventory: null,     // Map
  byLocation: null,    // Map
  selectedShip: null,
  desiredCount: null
};

const INVENTORY_URL =
'https://api.fnar.net/csv/inventory?apikey=e643e7c0-2d21-4508-9172-ead017ac00e1&username=Archiel&include_bases=true&include_warehouses=true&include_ship_stores=true&include_ship_stl_stores=false&include_ship_ftl_stores=false&include_header=true&agg';

for (const shipName of Object.keys(SHIP_RECIPES)) {
  const opt = document.createElement("option");
  opt.value = shipName;
  opt.textContent = shipName;
  shipSelect.appendChild(opt);
}

const fetchData = async () => {
  const cacheKey = "ship_inventory_cache";
  const TTL = 24 * 3600 * 1000;

  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      const { timestamp, data } = JSON.parse(cached);
      if (Date.now() - timestamp < TTL) {
        const { inventory, byLocation } = data;
        return {
          inventory: new Map(inventory),
          byLocation: new Map(byLocation),
          timestamp
        };
      }
    } catch {}
  }

  const response = await fetch(INVENTORY_URL);
  const csv = await response.text();
  const processed = processData(csv);

  localStorage.setItem(cacheKey, JSON.stringify({
    timestamp: Date.now(),
    data: {
      inventory: [...processed.inventory.entries()],
      byLocation: [...processed.byLocation.entries()]
    }
  }));

  return {
    ...processed,
    timestamp: Date.now()
  };
};


const formatInventoryAge = () => {
  const cacheKey = "ship_inventory_cache";
  const cached = localStorage.getItem(cacheKey);
  if (!cached) return null;

  try {
    const { timestamp } = JSON.parse(cached);
    const ageMs = Date.now() - timestamp;

    const seconds = Math.floor(ageMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);

    if (hours > 0) return `${hours} hour${hours !== 1 ? "s" : ""} ago`;
    if (minutes > 0) return `${minutes} minute${minutes !== 1 ? "s" : ""} ago`;
    return `${seconds} second${seconds !== 1 ? "s" : ""} ago`;
  } catch {
    return null;
  }
};

const renderInventoryTable = () => {
  const selectedShip = shipSelect.value;
  const desiredCount = parseInt(desiredInput.value, 10) || null;

  const table = createTable(
    appState.inventory,
    appState.byLocation,
    selectedShip,
    desiredCount
  );

  tableContainer.querySelector("table")?.remove();
  tableContainer.appendChild(table);

  // Update build count text
  const recipe = SHIP_RECIPES[selectedShip];
  const buildCount = calculateBuildCount(appState.byLocation, recipe);
  resultEl.textContent = `You can build ${buildCount.toLocaleString()} x ${selectedShip}`;
};

shipSelect.addEventListener("change", renderInventoryTable);
desiredInput.addEventListener("input", renderInventoryTable);

const calculateBuildCount = (byLocation, recipe) => {
  let maxBuilds = Infinity;

  for (const [ticker, required] of Object.entries(recipe)) {

	const loc = byLocation.get(ticker) || {};

	const ant = loc["ANT"] || 0;
	const hep = loc["ZV-307c"] || 0;
	const available = ant + hep;
    maxBuilds = Math.min(maxBuilds, Math.floor(available / required));
  }

  return Number.isFinite(maxBuilds) ? maxBuilds : 0;
};

const computeMissing = (ticker, available, recipe, desiredCount) => {
  if (!desiredCount) return "";

  const perShip = recipe[ticker];
  if (!perShip) return ""; // material not used by this ship

  const needed = perShip * desiredCount;
  const missing = Math.max(needed - available, 0);

  return missing ? missing.toLocaleString() : "";
};

const processData = (csvData) => {
  const inventory = new Map();
  const byLocation = new Map();

  const rows = csvData.trim().split('\n');
  const header = rows.shift().trim().split(',');

  const tickerIndex = header.indexOf('Ticker');
  const amountIndex = header.indexOf('Amount');
  const locationIndex = header.indexOf('NaturalId');

  for (const row of rows) {
    const values = row.split(',');
    const ticker = values[tickerIndex];
    const amount = parseInt(values[amountIndex], 10);
    const location = values[locationIndex];

    if (!SHIP_PART_TICKERS.has(ticker)) continue;

    // total
    inventory.set(ticker, (inventory.get(ticker) || 0) + amount);

    // by location
    if (!byLocation.has(ticker)) byLocation.set(ticker, {});
    byLocation.get(ticker)[location] =
      (byLocation.get(ticker)[location] || 0) + amount;
  }

  return { inventory, byLocation };
};


const createTable = (inventory, byLocation, selectedShip, desiredCount) => {
  const recipe = SHIP_RECIPES[selectedShip] || {};

  const table = document.createElement('table');
  table.className = 'table-auto w-full';

  table.innerHTML = `
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Total</th>
        <th>ANT</th>
        <th>Hephaestus</th>
        <th>Missing</th>
      </tr>
    </thead>
  `;

  const tbody = document.createElement("tbody");

  const sorted = [...inventory.keys()].sort();

  for (const ticker of sorted) {
    const total = inventory.get(ticker) || 0;
    const loc = byLocation.get(ticker) || {};

    const ant = loc["ANT"] || 0;
    const hep = loc["ZV-307c"] || 0;
  	const available = ant + hep;

    const missing = computeMissing(
      ticker,
      available,
      recipe,
      desiredCount
    );

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ticker}</td>
      <td>${total.toLocaleString()}</td>
      <td>${ant.toLocaleString()}</td>
      <td>${hep.toLocaleString()}</td>
      <td>${missing}</td>
    `;
    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  return table;
};


document.addEventListener("DOMContentLoaded", async () => {
  root.classList.add("opacity-50");
  resultEl.textContent = "Loading inventory dataâ€¦";

  const data = await fetchData();
  if (!data) {
    resultEl.textContent = "Failed to load inventory data.";
    return;
  }

  appState.inventory = data.inventory;
  appState.byLocation = data.byLocation;

  ageEl.textContent = `Inventory data from ${formatInventoryAge()}`;

  root.classList.remove("opacity-50");
  renderInventoryTable();
});

	
</script>